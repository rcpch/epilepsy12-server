# Generated by Django 4.2 on 2023-04-24 11:46
import logging

from django.db import migrations

from ..general_functions import fetch_ecl, add_epilepsy_cause_list_by_sctid

# Logging setup
logger = logging.getLogger(__name__)


def seed_epilepsy_causes(apps, schema_editor):
    """
    This returns all the snomed ct definitions and codes for epilepsy causes.
    Should be run periodically to compare with value in database and update record if has changed
    """

    # Get models
    EpilepsyCause = apps.get_model("epilepsy12", "EpilepsyCause")

    logger.info("\033[33m Seeding all the epilepsy causes from SNOMED... \033[33m")
    if EpilepsyCause.objects.count() > 150:
        logger.info("Causes already exist. Skipping this step...")
        return
    index = 0
    ecl = "<< 363235000"
    # calls the rcpch deprivare server for a list of causes using ECL query language
    epilepsy_causes = fetch_ecl(ecl)
    for cause in epilepsy_causes:
        if EpilepsyCause.objects.filter(conceptId=cause["conceptId"]).exists():
            # duplicate conceptId
            pass
        else:
            new_cause = EpilepsyCause(
                conceptId=cause["conceptId"],
                term=cause["term"],
                preferredTerm=cause["preferredTerm"],
            )
            try:
                new_cause.save()
                index += 1
            except Exception as e:
                logger.info(f"Epilepsy cause {cause['preferredTerm']} not added. {e}")
    logger.info(f"{index} epilepsy causes added")

    """
    These are additional causes added after go live
    Added here now so that any development work where the database has been reseeded
    remains in sync with what is live
    """

    # Constitutional mismatch repair deficiency syndrome (CMMRD) - 764946008
    # Neonatal hypoglycaemia - 52767006
    # Hypoxic ischaemic encephalopathy - 703300001
    # Perinatal arterial ischaemic stroke - 722929005
    # Non-accidental injury to child - 158094009
    # Periventricular leukomalacia - 230769007
    # Neonatal cerebral haemorrhage - 261808007
    # Cornelia de Lange Syndrome (CdLS) - 40354009
    # Anoxic encephalopathy - 389098007
    # Congenital Melanocytic Naevus â€“ 398696001
    # Megalencephalic leukoencephalopathy with subcortical cysts - 703536004
    # Cerebral ischemic stroke due to global hypoperfusion with watershed infarct - 788882003
    # Schizencephaly (disorder) - 253159001
    # Tetrasomy 12p syndrome (disorder) - 9527009
    # Dysembryoplastic neuroepithelial neoplasm of brain (disorder) - 1196837008
    extra_concept_ids = [
        764946008,
        52767006,
        703300001,
        722929005,
        158094009,
        230769007,
        261808007,
        40354009,
        389098007,
        398696001,
        703536004,
        788882003,
        253159001,
        9527009,
        1196837008,
    ]
    add_epilepsy_cause_list_by_sctid(extra_concept_ids=extra_concept_ids)


class Migration(migrations.Migration):
    dependencies = [
        ("epilepsy12", "0005_seed_organisations"),
    ]

    operations = [migrations.RunPython(seed_epilepsy_causes)]
