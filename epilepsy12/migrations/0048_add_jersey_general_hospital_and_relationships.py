# Generated by Django 5.1.2 on 2024-11-23 17:41

# python imports
from datetime import date
import logging

# Django imports
from django.db import migrations
from django.contrib.gis.geos import Point

# Epilepsy12 imports
from epilepsy12.constants import JERSEY_ORGANISATION, JERSEY_NHS_TRUST

logger = logging.getLogger(__name__)


def create_jersey_general_hospital(apps, schema_editor):
    """
    Create the Jersey General Hospital
    """
    Organisation = apps.get_model("epilepsy12", "Organisation")
    Trust = apps.get_model("epilepsy12", "Trust")
    Country = apps.get_model("epilepsy12", "Country")
    OPENUKNetwork = apps.get_model("epilepsy12", "OPENUKNetwork")

    jersey = Country.objects.get(boundary_identifier="JEY")
    swipe = OPENUKNetwork.objects.get(boundary_identifier="SWIPE")

    if Organisation.objects.filter(
        ods_code=JERSEY_ORGANISATION["OrganisationCode"]
    ).exists():
        logger.info("Jersey General Hospital already exists. Skipping creation.")
        return

    # Create the Jersey General Hospital trust and assign it to Jersey, the country
    jersey_trust = Trust.objects.create(
        ods_code=JERSEY_NHS_TRUST["ods_code"],
        name=JERSEY_NHS_TRUST["trust_name"],
        address_line_1=JERSEY_NHS_TRUST["address_line_1"],
        address_line_2=JERSEY_NHS_TRUST["address_line_2"],
        town=JERSEY_NHS_TRUST["town"],
        postcode=JERSEY_NHS_TRUST["postcode"],
        country=jersey.name,
        telephone=None,
        website=None,
        active=True,
        published_at=date(2015, 4, 1),
    )

    #  Create the Jersey General Hospital organisation and assign it to Jersey, the country and the Jersey General Hospital trust and the OPENUK Network
    Organisation.objects.create(
        ods_code=JERSEY_ORGANISATION["OrganisationCode"],
        name=JERSEY_ORGANISATION["OrganisationName"],
        website=JERSEY_ORGANISATION["Website"],
        address1=JERSEY_ORGANISATION["Address1"],
        address2=JERSEY_ORGANISATION["Address2"],
        address3=JERSEY_ORGANISATION["Address3"],
        city=JERSEY_ORGANISATION["City"],
        county=JERSEY_ORGANISATION["County"],
        latitude=float(JERSEY_ORGANISATION["Latitude"]),
        longitude=float(JERSEY_ORGANISATION["Longitude"]),
        postcode=JERSEY_ORGANISATION["Postcode"],
        geocode_coordinates=Point(
            x=float(JERSEY_ORGANISATION["Longitude"]),
            y=float(JERSEY_ORGANISATION["Latitude"]),
        ),
        telephone=JERSEY_ORGANISATION["Phone"],
        active=True,
        published_at=date(2015, 4, 1),
        country=jersey,
        trust=jersey_trust,
        local_health_board=None,
        openuk_network=swipe,
        nhs_england_region=None,
        integrated_care_board=None,
        london_borough=None,
    )

    logger.info("Jersey General Hospital created and all relationships added....")


class Migration(migrations.Migration):

    dependencies = [
        ("epilepsy12", "0047_add_jersey_boundaries_to_country_remap_identifier"),
    ]

    operations = [
        migrations.RunPython(create_jersey_general_hospital),
    ]
